<Page x:Class="DMPS.Client.Presentation.Views.Pages.StudyBrowserView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:DMPS.Client.Presentation.Views.Pages"
      xmlns:vm="clr-namespace:DMPS.Client.Presentation.ViewModels.Pages"
      xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
      mc:Ignorable="d" 
      d:DataContext="{d:DesignInstance Type=vm:StudyBrowserViewModel}"
      d:DesignHeight="450" d:DesignWidth="800"
      Title="StudyBrowserView">

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header and Actions -->
        <Grid Grid.Row="0" Margin="0 0 0 16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <TextBlock Text="Local Studies" Style="{StaticResource MaterialDesignHeadline5TextBlock}" VerticalAlignment="Center"/>

            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                        Command="{Binding ImportCommand}"
                        ToolTip="Import DICOM files from folder">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="FolderUpload" Margin="0 0 8 0"/>
                        <TextBlock Text="Import"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>

        <!-- Search and Filter Bar -->
        <materialDesign:Card Grid.Row="0" Margin="0 60 0 0" Padding="8" VerticalAlignment="Bottom">
             <Grid>
                 <Grid.ColumnDefinitions>
                     <ColumnDefinition Width="*"/>
                     <ColumnDefinition Width="Auto"/>
                     <ColumnDefinition Width="Auto"/>
                 </Grid.ColumnDefinitions>
                <TextBox materialDesign:HintAssist.Hint="Search by Patient Name, ID, or Study Description..."
                         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged, Delay=300}"
                         Style="{StaticResource MaterialDesignFloatingHintTextBox}"
                         materialDesign:TextFieldAssist.HasClearButton="True">
                     <materialDesign:HintAssist.Hint>
                         <StackPanel Orientation="Horizontal">
                             <materialDesign:PackIcon Kind="Search"/>
                             <TextBlock Text="Search Local Studies"/>
                         </StackPanel>
                     </materialDesign:HintAssist.Hint>
                 </TextBox>
                
                <DatePicker Grid.Column="1" Margin="16 0 0 0" Width="150"
                            materialDesign:HintAssist.Hint="Study Date"
                            SelectedDate="{Binding FilterDate}"
                            Style="{StaticResource MaterialDesignFloatingHintDatePicker}"/>

                <ComboBox Grid.Column="2" Margin="16 0 0 0" Width="150"
                          materialDesign:HintAssist.Hint="Modality"
                          ItemsSource="{Binding AvailableModalities}"
                          SelectedItem="{Binding FilterModality}"
                          Style="{StaticResource MaterialDesignFloatingHintComboBox}"/>
            </Grid>
        </materialDesign:Card>
        
        <!-- Study List -->
        <DataGrid Grid.Row="1"
                  ItemsSource="{Binding Studies}"
                  SelectedItem="{Binding SelectedStudy}"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  IsReadOnly="True"
                  CanUserSortColumns="True"
                  materialDesign:DataGridAssist.CellPadding="13 8 8 8"
                  materialDesign:DataGridAssist.ColumnHeaderPadding="8"
                  VirtualizingStackPanel.IsVirtualizing="True"
                  VirtualizingStackPanel.VirtualizationMode="Recycling">
            
            <DataGrid.InputBindings>
                <MouseBinding MouseAction="LeftDoubleClick" Command="{Binding OpenStudyCommand}" CommandParameter="{Binding SelectedStudy}"/>
            </DataGrid.InputBindings>

            <DataGrid.Columns>
                <DataGridTextColumn Header="Patient Name" Binding="{Binding PatientName}" Width="2*"/>
                <DataGridTextColumn Header="Patient ID" Binding="{Binding PatientId}" Width="1.5*"/>
                <DataGridTextColumn Header="Study Date" Binding="{Binding StudyDate, StringFormat='yyyy-MM-dd HH:mm'}" Width="1.5*"/>
                <DataGridTextColumn Header="Study Description" Binding="{Binding StudyDescription}" Width="3*"/>
                <DataGridTextColumn Header="Accession #" Binding="{Binding AccessionNumber}" Width="*"/>
                <DataGridTextColumn Header="Modality" Binding="{Binding Modalities}" Width="*"/>
                <DataGridTextColumn Header="Series" Binding="{Binding SeriesCount}" Width="Auto"/>
                <DataGridTextColumn Header="Images" Binding="{Binding ImageCount}" Width="Auto"/>
                <DataGridTemplateColumn Header="Actions" Width="Auto">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <Button Style="{StaticResource MaterialDesignFlatButton}"
                                        ToolTip="Open Study"
                                        Command="{Binding DataContext.OpenStudyCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding}">
                                    <materialDesign:PackIcon Kind="FolderOpen"/>
                                </Button>
                                <Button Style="{StaticResource MaterialDesignFlatButton}"
                                        ToolTip="Export Study"
                                        Command="{Binding DataContext.ExportStudyCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding}">
                                    <materialDesign:PackIcon Kind="Export"/>
                                </Button>
                                <Button Style="{StaticResource MaterialDesignFlatButton}"
                                        ToolTip="Delete Study"
                                        Foreground="{DynamicResource MaterialDesignValidationErrorBrush}"
                                        Command="{Binding DataContext.DeleteStudyCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding}">
                                    <materialDesign:PackIcon Kind="Delete"/>
                                </Button>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>
        
        <!-- Loading Indicator -->
        <Grid Grid.Row="1" Background="#77FFFFFF" Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
            <ProgressBar IsIndeterminate="True" Style="{StaticResource MaterialDesignCircularProgressBar}" Width="50" Height="50"/>
        </Grid>
    </Grid>
</Page>